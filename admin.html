<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sewar Admin | Command Center v5</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* --- CSS STYLES --- */
        :root { 
            --bg: #02040a; 
            --card-bg: rgba(13, 17, 23, 0.95);
            --text-main: #e6edf3;
            --cyan: #00f3ff;
            --purple: #bc13fe; 
            --danger: #ff0055; 
            --success: #00ff9d; 
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        * { box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text-main); overflow-x: hidden; background-image: radial-gradient(circle at 50% 50%, #0a101f 0%, #000000 100%); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--purple); border-radius: 3px; }

        /* UTILS */
        .glass-panel {
            background: var(--card-bg);
            border: var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        .text-cyan { color: var(--cyan); text-shadow: 0 0 5px var(--cyan); }
        .text-purple { color: var(--purple); text-shadow: 0 0 5px var(--purple); }

        /* LOGIN SCREEN */
        #loginScreen { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: black; z-index:999; display:flex; flex-direction:column; 
            align-items:center; justify-content:center;
        }
        .cyber-input {
            background: rgba(0,0,0,0.5); border: 1px solid #444; color: white;
            padding: 10px; width: 100%; outline: none; border-radius: 4px;
            transition: 0.3s; font-family: 'Share Tech Mono'; margin-bottom: 10px;
        }
        .cyber-input:focus { border-color: var(--cyan); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        
        .btn { padding: 10px 20px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.3s; text-transform: uppercase; }
        .btn-primary { background: var(--cyan); color: black; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(0, 243, 255, 0.5); }
        .btn-danger { background: var(--danger); color: white; }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: 260px 1fr; height: 100vh; display:none; }
        
        /* SIDEBAR */
        .sidebar { background: rgba(5, 5, 10, 0.95); border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; }
        .nav-btn { background: transparent; border: none; color: #8b949e; text-align: left; padding: 15px; font-size: 1.1rem; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .nav-btn:hover, .nav-btn.active { background: rgba(188, 19, 254, 0.15); color: white; border-left: 4px solid var(--purple); }

        /* CONTENT AREA */
        .main-content { padding: 30px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 20px; position: relative; overflow: hidden; }
        .stat-val { font-size: 2.5rem; font-weight: 700; font-family: 'Share Tech Mono'; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 15px; background: rgba(255,255,255,0.05); color: var(--cyan); border-bottom: 1px solid #333; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ccc; }
        
        /* DROPDOWN CUSTOM */
        select.cyber-input {
            background-color: #0d1117;
        }

        /* TERMINAL */
        .ai-terminal {
            position: fixed; bottom: 20px; right: 20px; width: 320px; height: 160px;
            background: rgba(0,0,0,0.9); border: 1px solid var(--success);
            padding: 10px; font-family: 'Share Tech Mono'; font-size: 0.8rem;
            color: var(--success); overflow-y: auto; z-index: 100;
            border-left: 5px solid var(--success);
            pointer-events: none;
        }

        @media(max-width: 768px) { .dashboard { grid-template-columns: 1fr; } .sidebar { display:none; } .ai-terminal { display:none; } }
    </style>
</head>
<body>

    <div id="loginScreen">
        <i class="fas fa-fingerprint" style="font-size: 80px; color: var(--purple); margin-bottom: 20px;"></i>
        <h2 class="text-cyan" style="font-family: 'Share Tech Mono'; letter-spacing: 3px;">SYSTEM LOCKED</h2>
        <input type="password" id="adminPass" class="cyber-input" style="width: 200px; text-align: center; font-size: 1.2rem;" placeholder="ENTER PIN">
        <button onclick="checkLogin()" class="btn btn-primary" style="margin-top:20px;">UNLOCK CORE</button>
        <p id="loginMsg" style="color:var(--danger); display:none; margin-top:10px;">ACCESS DENIED</p>
    </div>

    <div class="dashboard" id="mainDash">
        <aside class="sidebar">
            <div class="logo text-cyan" style="text-align:center; font-size:1.5rem; margin-bottom:30px;">
                <i class="fas fa-atom"></i> SEWAR<br>
                <span style="font-size:0.8rem; color:var(--purple)">ADMIN CORE</span>
            </div>
            
            <button class="nav-btn active" onclick="showSection('overview')">
                <i class="fas fa-satellite"></i> Overview
            </button>
            <button class="nav-btn" onclick="showSection('requests')">
                <i class="fas fa-tasks"></i> Mission Control
            </button>
            <button class="nav-btn" onclick="showSection('partners')">
                <i class="fas fa-user-shield"></i> Agents (Partners)
            </button>
            <button class="nav-btn" onclick="showSection('products')">
                <i class="fas fa-boxes"></i> Inventory Rates
            </button>
        </aside>

        <main class="main-content">
            <div id="overview">
                <h2 class="text-cyan">LIVE TELEMETRY</h2>
                <div class="stats-grid">
                    <div class="glass-panel stat-card">
                        <div style="color:#888; font-size:0.9rem;">PENDING REQUESTS</div>
                        <div class="stat-val text-cyan" id="pendingCount">--</div>
                    </div>
                    <div class="glass-panel stat-card">
                        <div style="color:#888; font-size:0.9rem;">ACTIVE AGENTS</div>
                        <div class="stat-val text-purple" id="agentCount">--</div>
                    </div>
                </div>
                <div class="glass-panel" style="padding:20px; height:300px;">
                     <canvas id="myChart"></canvas>
                </div>
            </div>

            <div id="requests" style="display:none;">
                <h2 class="text-cyan">INCOMING TRANSMISSIONS (REQUESTS)</h2>
                <div class="glass-panel table-container">
                    <table id="reqTable">
                        <thead>
                            <tr>
                                <th>CUSTOMER</th>
                                <th>ITEMS</th>
                                <th>STATUS</th>
                                <th>ASSIGN TO AGENT</th>
                                <th>ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="reqTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="partners" style="display:none;">
                <h2 class="text-purple">CREATE AGENT ACCESS</h2>
                <div class="glass-panel" style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <input type="text" id="pName" placeholder="Partner Name" class="cyber-input">
                        <input type="text" id="pId" placeholder="Login ID (Unique)" class="cyber-input">
                        <input type="password" id="pPass" placeholder="Access Password" class="cyber-input">
                    </div>
                    <button onclick="createPartner()" class="btn btn-primary" style="width:100%; margin-top:15px;">GRANT ACCESS</button>
                </div>

                <h3 class="text-cyan">ACTIVE FIELD AGENTS</h3>
                <div class="glass-panel table-container">
                    <table id="partnerTable">
                        <thead><tr><th>NAME</th><th>LOGIN ID</th><th>ACTION</th></tr></thead>
                        <tbody id="partnerTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="products" style="display:none;">
                <h2 class="text-cyan">GLOBAL MARKET RATES</h2>
                <div class="glass-panel" style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <input type="text" id="newName" placeholder="Item Name" class="cyber-input">
                        <input type="number" id="newPrice" placeholder="Price" class="cyber-input">
                        <select id="newTrend" class="cyber-input">
                            <option value="stable">Stable</option>
                            <option value="up">Bullish ðŸ“ˆ</option>
                            <option value="down">Bearish ðŸ“‰</option>
                        </select>
                        <select id="newUnit" class="cyber-input">
                            <option value="kg">Per Kg</option>
                            <option value="pc">Per Pc</option>
                        </select>
                    </div>
                    <button onclick="addNewProduct()" class="btn btn-primary" style="width:100%; margin-top:15px;">UPDATE DATABASE</button>
                </div>
                <div class="glass-panel table-container">
                    <table id="adminTable">
                        <thead><tr><th>NAME</th><th>RATE (â‚¹)</th><th>TREND</th><th>ACTION</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>

        <div class="ai-terminal" id="aiTerminal">
            > SYSTEM INITIALIZING...<br>
        </div>
    </div>

    <script>
        // ðŸ”´ðŸ”´ðŸ”´ FIREBASE CONFIG ðŸ”´ðŸ”´ðŸ”´
        const firebaseConfig = {
            apiKey: "AIzaSyC-nreyuj5Qj1sdOMBh1D5Q8n1t090Yo04",
            authDomain: "smartkabadi-945b9.firebaseapp.com",
            projectId: "smartkabadi-945b9",
            storageBucket: "smartkabadi-945b9.firebasestorage.app",
            messagingSenderId: "92850793972",
            appId: "1:92850793972:web:50f1cfce0e8d74c2f1dda1",
            measurementId: "G-K8X0E3MGBB"
        };

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            logToTerminal("CORE CONNECTED âœ…", "#00ff9d");
        } catch (error) {
            console.error(error);
        }

        // --- LOGIN ---
        function checkLogin() {
            const pin = document.getElementById('adminPass').value;
            if(pin === "1234") { 
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDash').style.display = 'grid';
                loadData();
                initChart();
            } else {
                document.getElementById('loginMsg').style.display = 'block';
            }
        }

        // --- NAVIGATION ---
        function showSection(id) {
            ['overview','requests','partners','products'].forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // --- DATA LOADING & LOGIC ---
        let partnersList = [];

        function loadData() {
            if(!db) return;

            // 1. Fetch Partners (For Dropdown & List)
            db.collection("dealers").onSnapshot(snap => {
                const tbody = document.getElementById('partnerTableBody');
                tbody.innerHTML = '';
                partnersList = [];
                let count = 0;
                
                snap.forEach(doc => {
                    const p = doc.data();
                    partnersList.push({id: doc.id, name: p.name});
                    count++;
                    tbody.innerHTML += `
                        <tr>
                            <td class="text-cyan">${p.name}</td>
                            <td>${p.loginId}</td>
                            <td><button onclick="deletePartner('${doc.id}')" class="btn btn-danger" style="padding:5px;">REVOKE</button></td>
                        </tr>
                    `;
                });
                document.getElementById('agentCount').innerText = count;
                logToTerminal(`AGENTS SYNCED: ${count}`, "#bc13fe");
            });

            // 2. Fetch Requests (Only Unassigned or Pending Admin)
            db.collection("pickup_requests").orderBy("timestamp", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('reqTableBody');
                tbody.innerHTML = '';
                let pending = 0;

                snap.forEach(doc => {
                    const r = doc.data();
                    // Default Status if not set
                    const status = r.status || 'Pending Approval';
                    
                    // Dropdown HTML Generation
                    let options = `<option value="">-- Select Agent --</option>`;
                    partnersList.forEach(p => {
                        const selected = r.assigned_to === p.id ? 'selected' : '';
                        options += `<option value="${p.id}" ${selected}>${p.name}</option>`;
                    });

                    // Only show if not completed/cancelled for clarity (optional)
                    if(status !== 'Completed' && status !== 'Cancelled') {
                        pending++;
                        tbody.innerHTML += `
                            <tr>
                                <td><b style="color:white;">${r.name}</b><br><small>${r.phone}</small></td>
                                <td>Total: â‚¹${r.total_amount || 0}</td>
                                <td><span style="color:${status === 'Assigned' ? '#00ff9d' : '#ff0055'}">${status}</span></td>
                                <td>
                                    <select id="sel-${doc.id}" class="cyber-input" style="margin:0; padding:5px;">
                                        ${options}
                                    </select>
                                </td>
                                <td>
                                    <button onclick="pushToAgent('${doc.id}')" class="btn btn-primary" style="padding:5px 15px;">PUSH <i class="fas fa-paper-plane"></i></button>
                                </td>
                            </tr>
                        `;
                    }
                });
                document.getElementById('pendingCount').innerText = pending;
            });

            // 3. Load Inventory Rates
            db.collection("rates").onSnapshot(snap => {
                const tbody = document.querySelector('#adminTable tbody');
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const item = doc.data();
                    tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.price}</td><td>${item.trend}</td><td><button onclick="deleteItem('${doc.id}')" class="btn" style="color:var(--danger)">DEL</button></td></tr>`;
                });
            });
        }

        // --- PARTNER MANAGEMENT ---
        function createPartner() {
            const name = document.getElementById('pName').value;
            const loginId = document.getElementById('pId').value;
            const pass = document.getElementById('pPass').value;

            if(!name || !loginId || !pass) {
                alert("Fill all fields"); return;
            }

            db.collection("dealers").add({
                name: name,
                loginId: loginId,
                password: pass, // Note: In production, hash this!
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                logToTerminal("NEW AGENT CREATED", "#00ff9d");
                document.getElementById('pName').value = '';
                document.getElementById('pId').value = '';
                document.getElementById('pPass').value = '';
            });
        }

        function deletePartner(id) {
            if(confirm("Revoke Agent Access?")) db.collection("dealers").doc(id).delete();
        }

        // --- MISSION CONTROL (ASSIGNMENT) ---
        function pushToAgent(reqId) {
            const selectBox = document.getElementById(`sel-${reqId}`);
            const agentId = selectBox.value;

            if(!agentId) {
                alert("Please select an agent first!"); return;
            }

            db.collection("pickup_requests").doc(reqId).update({
                assigned_to: agentId,
                status: "Assigned" // Request now visible to Dealer
            }).then(() => {
                logToTerminal(`TASK PUSHED TO AGENT`, "#00f3ff");
                alert("Request Pushed to Dealer Successfully!");
            }).catch(err => console.error(err));
        }

        // --- INVENTORY ---
        function addNewProduct() {
             const name = document.getElementById('newName').value;
             const price = document.getElementById('newPrice').value;
             if(name && price) {
                 db.collection("rates").add({ name, price: Number(price), trend: document.getElementById('newTrend').value });
                 logToTerminal("INVENTORY UPDATED", "yellow");
             }
        }
        function deleteItem(id) { db.collection("rates").doc(id).delete(); }

        // --- UTILS ---
        function logToTerminal(msg, color) {
            const term = document.getElementById('aiTerminal');
            term.innerHTML += `> <span style="color:${color}">${msg}</span><br>`;
            term.scrollTop = term.scrollHeight;
        }

        function initChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { labels: ['10am', '12pm', '2pm', '4pm'], datasets: [{ label: 'Traffic', data: [5, 12, 8, 20], borderColor: '#00f3ff', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
