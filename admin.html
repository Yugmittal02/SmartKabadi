<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sewar Admin | AI Nexus Core v6.6 (Revenue Tracing)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* --- CSS STYLES START --- */
        :root { 
            --bg: #02040a; 
            --card-bg: rgba(13, 17, 23, 0.9);
            --text-main: #e6edf3;
            --cyan: #00f3ff;
            --purple: #bc13fe; 
            --danger: #ff0055; 
            --success: #00ff9d; 
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        * { box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text-main); overflow-x: hidden; background-image: radial-gradient(circle at 50% 50%, #0a101f 0%, #000000 100%); padding-bottom: 300px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--purple); border-radius: 3px; }

        /* UTILS */
        .glass-panel {
            background: var(--card-bg);
            border: var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        .text-cyan { color: var(--cyan); text-shadow: 0 0 5px var(--cyan); }
        .text-purple { color: var(--purple); text-shadow: 0 0 5px var(--purple); }
        .text-success { color: var(--success); text-shadow: 0 0 5px var(--success); }

        /* PULSE ANIMATION FOR LIVE USERS */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 157, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0); }
        }
        .live-indicator {
            display: inline-block; width: 10px; height: 10px; 
            background: var(--success); border-radius: 50%; 
            margin-right: 8px; animation: pulse-green 2s infinite;
        }

        /* LOGIN SCREEN */
        #loginScreen { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: black; z-index:999; display:flex; flex-direction:column; 
            align-items:center; justify-content:center;
        }
        .cyber-input {
            background: rgba(0,0,0,0.5); border: 1px solid #444; color: white;
            padding: 10px; width: 100%; outline: none; border-radius: 4px;
            transition: 0.3s; font-family: 'Share Tech Mono';
        }
        .cyber-input:focus { border-color: var(--cyan); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        
        .btn { padding: 10px 20px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.3s; text-transform: uppercase; }
        .btn-primary { background: var(--cyan); color: black; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(0, 243, 255, 0.5); }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: 260px 1fr; height: 100vh; display:none; }
        
        /* SIDEBAR */
        .sidebar { background: rgba(5, 5, 10, 0.95); border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; }
        .nav-btn { background: transparent; border: none; color: #8b949e; text-align: left; padding: 15px; font-size: 1.1rem; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .nav-btn:hover, .nav-btn.active { background: rgba(188, 19, 254, 0.15); color: white; border-left: 4px solid var(--purple); }

        /* CONTENT AREA */
        .main-content { padding: 30px; overflow-y: auto; height: calc(100vh - 250px); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 20px; position: relative; overflow: hidden; }
        .stat-val { font-size: 2.5rem; font-weight: 700; font-family: 'Share Tech Mono'; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 15px; background: rgba(255,255,255,0.05); color: var(--cyan); }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ddd; }
        
        /* TERMINAL */
        .ai-terminal-wrapper {
            position: fixed; bottom: 10px; right: 10px; left: 270px;
            height: 250px;
            background: rgba(0,0,0,0.95); border: 1px solid var(--success);
            display: flex; flex-direction: column;
            font-family: 'Share Tech Mono'; font-size: 0.85rem;
            color: var(--success); z-index: 100;
            box-shadow: 0 -5px 20px rgba(0, 255, 157, 0.1);
        }
        .term-header {
            background: #0f1a15; padding: 5px 10px; border-bottom: 1px solid var(--success);
            font-size: 0.8rem; letter-spacing: 2px; color: #00ff9d;
            display: flex; justify-content: space-between;
        }
        .term-body { display: flex; flex: 1; overflow: hidden; }
        .term-col { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
        .term-col-left { border-right: 1px dashed #333; }
        .term-title { color: var(--purple); font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .log-entry { margin-bottom: 4px; line-height: 1.3; }
        
        @media(max-width: 768px) { 
            .dashboard { grid-template-columns: 1fr; } 
            .sidebar { display:none; } 
            .ai-terminal-wrapper { left: 10px; height: 200px; }
            .term-body { flex-direction: column; }
            .term-col-left { border-right: none; border-bottom: 1px dashed #333; }
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <i class="fas fa-fingerprint" style="font-size: 80px; color: var(--purple); margin-bottom: 20px;"></i>
        <h2 class="text-cyan" style="font-family: 'Share Tech Mono'; letter-spacing: 3px;">SYSTEM LOCKED</h2>
        <input type="password" id="adminPass" class="cyber-input" style="width: 200px; text-align: center; font-size: 1.2rem;" placeholder="ENTER PIN">
        <button onclick="checkLogin()" class="btn btn-primary" style="margin-top:20px;">UNLOCK CORE</button>
        <p id="loginMsg" style="color:var(--danger); display:none; margin-top:10px;">ACCESS DENIED</p>
    </div>

    <div class="dashboard" id="mainDash">
        <aside class="sidebar">
            <div class="logo text-cyan" style="text-align:center; font-size:1.5rem; margin-bottom:30px;">
                <i class="fas fa-atom"></i> SEWAR<br>
                <span style="font-size:0.8rem; color:var(--purple)">ADMIN CORE</span>
            </div>
            
            <button class="nav-btn active" onclick="showSection('overview')">
                <i class="fas fa-satellite"></i> Overview
            </button>
            <button class="nav-btn" onclick="showSection('requests')">
                <i class="fas fa-clipboard-list"></i> Customer Requests
                <span id="reqBadge" style="background:var(--danger); font-size:0.7rem; padding:2px 6px; border-radius:50%; margin-left:auto; display:none;">New</span>
            </button>
            <button class="nav-btn" onclick="showSection('products')">
                <i class="fas fa-boxes"></i> Inventory
            </button>
            <button class="nav-btn" onclick="showSection('users')">
                <i class="fas fa-users-cog"></i> User Spy Net
            </button>
        </aside>

        <main class="main-content">
            <div id="overview">
                <h2 class="text-cyan">LIVE TELEMETRY</h2>
                <div class="stats-grid">
                    <div class="glass-panel stat-card">
                        <div style="color:#888; font-size:0.9rem;"><span class="live-indicator"></span>ONLINE NOW</div>
                        <div class="stat-val text-success" id="activeUserCount">0</div>
                        <div style="font-size:0.7rem; color:#666; margin-top:5px;">REALTIME SESSION TRACKING</div>
                    </div>
                    <div class="glass-panel stat-card">
                        <div style="color:#888; font-size:0.9rem;">VISITS TODAY</div>
                        <div class="stat-val text-cyan" id="visitCount">--</div>
                        <div style="font-size:0.7rem; color:#666; margin-top:5px;">SINCE 00:00 HOURS</div>
                    </div>
                    <div class="glass-panel stat-card" style="border-color: var(--success);">
                        <div style="color:#888; font-size:0.9rem;">PENDING REQUESTS</div>
                        <div class="stat-val" style="color: var(--success);" id="requestCount">0</div>
                    </div>
                </div>
                <div class="glass-panel" style="padding:20px; height:300px;">
                     <canvas id="myChart"></canvas>
                </div>
            </div>

            <div id="requests" style="display:none;">
                <h2 class="text-cyan">INCOMING PICKUP REQUESTS</h2>
                <div class="glass-panel table-container">
                    <table id="requestsTable">
                        <thead>
                            <tr>
                                <th>DATE / TIME</th>
                                <th>CUSTOMER NAME</th>
                                <th>PHONE</th>
                                <th style="color: var(--success);">EST. VALUE (‚Çπ)</th>
                                <th>ADDRESS / MESSAGE</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr><td colspan="5">Listening for data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="products" style="display:none;">
                <h2 class="text-cyan">ADD NEW ASSET</h2>
                <div class="glass-panel" style="padding: 20px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <input type="text" id="newName" placeholder="Item Name (e.g. Iron)" class="cyber-input">
                        <input type="number" id="newPrice" placeholder="Price (e.g. 30)" class="cyber-input">
                        <select id="newTrend" class="cyber-input">
                            <option value="stable">Stable</option>
                            <option value="up">Bullish üìà</option>
                            <option value="down">Bearish üìâ</option>
                        </select>
                        <select id="newUnit" class="cyber-input">
                            <option value="kg">Per Kg</option>
                            <option value="pc">Per Pc</option>
                        </select>
                    </div>
                    <button onclick="addNewProduct()" class="btn btn-primary" style="width:100%; margin-top:15px;">INJECT TO DATABASE</button>
                </div>

                <div class="glass-panel table-container">
                    <table id="adminTable">
                        <thead>
                            <tr><th>NAME</th><th>RATE (‚Çπ)</th><th>TREND</th><th>ACTION</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="users" style="display:none;">
                <h2 class="text-purple">REALTIME USER TRACKER</h2>
                <div class="glass-panel table-container" style="padding:10px;">
                    <table id="userTable">
                        <thead><tr><th>TIME</th><th>IP / LOCATION</th><th>DEVICE</th><th>TRUST</th><th>ACTION</th></tr></thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <div class="ai-terminal-wrapper" id="aiTerminal">
            <div class="term-header">
                <span>:: SYSTEM DIAGNOSTICS ::</span>
                <span>STATUS: ONLINE</span>
            </div>
            <div class="term-body">
                <div class="term-col term-col-left" id="sysHealthCol">
                    <div class="term-title">>> SYSTEM HEALTH (ADMIN + CUST)</div>
                    <div id="healthLogs"></div>
                </div>
                <div class="term-col" id="bizIntelCol">
                    <div class="term-title">>> BUSINESS INTELLIGENCE</div>
                    <div id="bizLogs"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC-nreyuj5Qj1sdOMBh1D5Q8n1t090Yo04",
            authDomain: "smartkabadi-945b9.firebaseapp.com",
            projectId: "smartkabadi-945b9",
            storageBucket: "smartkabadi-945b9.firebasestorage.app",
            messagingSenderId: "92850793972",
            appId: "1:92850793972:web:50f1cfce0e8d74c2f1dda1",
            measurementId: "G-K8X0E3MGBB"
        };

        let db;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            logHealth("FIREBASE CONNECTED ‚úÖ", "#00ff9d");
            startSystemSim();
        } catch (error) {
            logHealth("‚ö†Ô∏è FIREBASE ERROR: CHECK CONSOLE", "red");
            console.error(error);
        }

        function checkLogin() {
            const pin = document.getElementById('adminPass').value;
            if(pin === "1234") { 
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDash').style.display = 'grid';
                logHealth("ADMIN AUTHENTICATED: LEVEL 1", "#00f3ff");
                loadData();
                initChart();
            } else {
                document.getElementById('loginMsg').style.display = 'block';
                logHealth("INTRUDER ALERT: WRONG PIN", "red");
            }
        }

        function showSection(id) {
            document.getElementById('overview').style.display = 'none';
            document.getElementById('products').style.display = 'none';
            document.getElementById('users').style.display = 'none';
            document.getElementById('requests').style.display = 'none';
            document.getElementById(id).style.display = 'block';
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function loadData() {
            if(!db) return;

            // 1. Inventory
            db.collection("rates").onSnapshot((snapshot) => {
                const tbody = document.querySelector('#adminTable tbody');
                tbody.innerHTML = '';
                let count = 0;
                snapshot.forEach((doc) => {
                    const item = doc.data();
                    count++;
                    const row = `<tr>
                        <td style="color:white;">${item.name}</td>
                        <td><input type="number" value="${item.price}" onchange="updatePrice('${doc.id}', this.value)" class="cyber-input" style="width:80px;"></td>
                        <td>${item.trend}</td>
                        <td><button onclick="deleteItem('${doc.id}')" class="btn" style="color:var(--danger); padding:5px;">DEL</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                logBiz(`INVENTORY UPDATE: ${count} Items Active`, "#bc13fe");
            });

            // 2. Active & Daily Users
            const todayStart = new Date();
            todayStart.setHours(0,0,0,0);

            db.collection("active_users")
              .where("timestamp", ">=", todayStart)
              .orderBy("timestamp", "desc")
              .onSnapshot((snapshot) => {
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                let totalToday = 0;
                let activeNow = 0;
                const now = new Date();
                const activeThreshold = 5 * 60 * 1000;

                snapshot.forEach((doc) => {
                    const u = doc.data();
                    const visitTime = u.timestamp ? u.timestamp.toDate() : new Date();
                    totalToday++;
                    const timeDiff = now - visitTime;
                    let isActive = false;
                    if (timeDiff < activeThreshold) { activeNow++; isActive = true; }

                    let color = u.trustScore > 80 ? '#00ff9d' : '#ff0055';
                    let statusDot = isActive ? '<span style="color:#00ff9d">‚óè</span>' : '<span style="color:#555">‚óè</span>';
                    const timeString = visitTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    const row = `<tr style="animation: fadeIn 0.5s;">
                        <td style="color:var(--cyan); font-family:'Share Tech Mono';">${statusDot} ${timeString}</td>
                        <td><b style="color:white;">${u.ip}</b><br><span style="font-size:0.8rem; color:#888;">${u.city}</span></td>
                        <td style="color:#aaa;">${u.device}</td>
                        <td style="color:${color}">${u.trustScore}%</td>
                        <td><button onclick="deleteUser('${doc.id}')" class="btn" style="padding:5px; font-size:0.8rem; border:1px solid #444;">CLEAR</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                document.getElementById('visitCount').innerText = totalToday;
                document.getElementById('activeUserCount').innerText = activeNow;
                if(activeNow > 0) logHealth(`üü¢ ALERT: ${activeNow} USERS ACTIVE`, "#00ff9d");
            });

            // 3. Customer Requests (WITH ORDER VALUE)
            db.collection("pickup_requests").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                const tbody = document.getElementById('requestsTableBody');
                tbody.innerHTML = '';
                let reqCount = 0;
                
                snapshot.forEach((doc) => {
                    const r = doc.data();
                    reqCount++;
                    let dateString = r.timestamp ? new Date(r.timestamp.toDate()).toLocaleString('en-IN', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }) : "Pending";
                    
                    // Value Handling
                    let amount = r.total_amount ? r.total_amount : 0;

                    const row = `<tr style="border-left: 2px solid var(--cyan); background: rgba(0,243,255,0.05);">
                        <td style="color:var(--cyan); font-family:'Share Tech Mono';">${dateString}</td>
                        <td style="font-weight:bold; color:white;">${r.name || 'Unknown'}</td>
                        <td><a href="tel:${r.phone}" style="color:var(--success); text-decoration:none;">${r.phone}</a></td>
                        
                        <td style="color:var(--success); font-weight:bold; font-family:'Share Tech Mono'; font-size:1.1rem;">‚Çπ${amount}</td>
                        
                        <td style="font-size:0.9rem; color:#ccc;">${r.address}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                document.getElementById('requestCount').innerText = reqCount;
                if(reqCount > 0) {
                    document.getElementById('reqBadge').style.display = 'inline-block';
                    logBiz(`NEW LEAD: ${reqCount} Pending Requests`, "yellow");
                }
            });
        }

        // --- UTILS ---
        function logHealth(msg, color) {
            const container = document.getElementById('healthLogs');
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            container.innerHTML = `<div class="log-entry">[${time}] <span style="color:${color}">${msg}</span></div>` + container.innerHTML;
        }

        function logBiz(msg, color) {
            const container = document.getElementById('bizLogs');
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            container.innerHTML = `<div class="log-entry">[${time}] <span style="color:${color}">${msg}</span></div>` + container.innerHTML;
        }

        function startSystemSim() {
            setInterval(() => {
                const latency = Math.floor(Math.random() * 50) + 10;
                logHealth(`SERVER LATENCY: ${latency}ms (STABLE)`, "#888");
            }, 5000);
        }

        function addNewProduct() {
            const name = document.getElementById('newName').value;
            const price = Number(document.getElementById('newPrice').value);
            const trend = document.getElementById('newTrend').value;
            const unit = document.getElementById('newUnit').value;
            if(!name || !price) { logBiz("ERROR: INVALID INPUT", "red"); return; }
            db.collection("rates").add({ name, price, trend, unit }).then(() => {
                logBiz("ASSET INJECTED SUCCESSFULLY", "#00ff9d");
                document.getElementById('newName').value = "";
                document.getElementById('newPrice').value = "";
            });
        }

        function updatePrice(id, newPrice) {
            db.collection("rates").doc(id).update({ price: Number(newPrice) });
            logBiz("MARKET PRICE ADJUSTED", "yellow");
        }

        function deleteItem(id) {
            if(confirm("Delete this asset?")) {
                db.collection("rates").doc(id).delete();
                logBiz("ASSET REMOVED FROM DB", "red");
            }
        }
        function deleteUser(id) { db.collection("active_users").doc(id).delete(); }

        function initChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                    datasets: [{
                        label: 'Traffic Flow (Last 24h)',
                        data: [5, 2, 8, 15, 25, 10], 
                        borderColor: '#00f3ff',
                        backgroundColor: 'rgba(0, 243, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { grid: { color: 'rgba(255,255,255,0.05)' } }
                    },
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });
        }
    </script>
</body>
</html>
